# =============================================================================
# CI/CD Pipeline - ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
# =============================================================================
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
# 1. ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ³ãƒˆã€å‹ãƒã‚§ãƒƒã‚¯ï¼‰
# 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# 3. ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
# 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
# 5. æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
# =============================================================================

name: CI/CD Pipeline

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼šmain/developãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¨PR
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°
env:
  NODE_VERSION: '18' # Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  DATABASE_URL: ${{ secrets.DATABASE_URL }} # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURLï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰

jobs:
  # =============================================================================
  # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ– - ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  # =============================================================================
  setup:
    runs-on: ubuntu-latest
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm' # npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci # package-lock.jsonã«åŸºã¥ã„ã¦å³å¯†ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      # Prismaã¨node_modulesã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: Cache Prisma
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  # =============================================================================
  # ãƒªãƒ³ãƒˆã‚¸ãƒ§ãƒ– - ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒã‚§ãƒƒã‚¯
  # =============================================================================
  lint:
    runs-on: ubuntu-latest
    needs: setup # setupã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ESLintã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      - name: Run ESLint
        run: npm run lint

      # Prettierã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: Run Prettier check
        run: npm run format:check

  # =============================================================================
  # å‹ãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ– - TypeScriptã®å‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
  # =============================================================================
  type-check:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«ã‚ˆã‚‹å‹ãƒã‚§ãƒƒã‚¯
      - name: Run TypeScript check
        run: npm run type-check

  # =============================================================================
  # ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ– - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
  # =============================================================================
  test:
    runs-on: ubuntu-latest
    needs: setup
    # PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup test database
        run: |
          npx prisma generate
          npx prisma db push --schema=./prisma/schema.prisma
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          NODE_ENV: test

      # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      - name: Run tests
        run: npm test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          NODE_ENV: test

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç”Ÿæˆ
      - name: Run test coverage
        run: npm run test:coverage
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          NODE_ENV: test

  # =============================================================================
  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ– - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  # =============================================================================
  build:
    runs-on: ubuntu-latest
    needs: [lint, type-check, test] # å‰æ®µéšã®ã‚¸ãƒ§ãƒ–ãŒå…¨ã¦æˆåŠŸã™ã‚‹ã“ã¨ã‚’è¦æ±‚
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”Ÿæˆã®ã¿ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãªã—ï¼‰
      - name: Generate Prisma Client
        run: npx prisma generate

      # Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            .next/
            public/
            package.json
            prisma/schema.prisma

  # =============================================================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¸ãƒ§ãƒ– - ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
  # =============================================================================
  security:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # npm auditã«ã‚ˆã‚‹è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
      - name: Run security audit
        run: npm audit --audit-level=moderate

      # Snykã«ã‚ˆã‚‹è©³ç´°ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Run Snyk security scan (optional)
        # Snykãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=all
        continue-on-error: true # å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š

  # =============================================================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ– - æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  # =============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, build, security] # å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’è¦æ±‚
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç›´å‰ã«å®Ÿè¡Œï¼‰
      - name: Apply database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Vercelã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

  # =============================================================================
  # é€šçŸ¥ã‚¸ãƒ§ãƒ– - ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥
  # =============================================================================
  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() # ãƒ‡ãƒ—ãƒ­ã‚¤ã®æˆåŠŸãƒ»å¤±æ•—ã«é–¢ä¿‚ãªãå®Ÿè¡Œ
    steps:
      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ™‚ã®é€šçŸ¥
      - name: Notify on success
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "Application deployed to production"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®é€šçŸ¥
      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs for more details"
